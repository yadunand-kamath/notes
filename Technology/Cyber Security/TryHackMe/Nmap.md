
#nmap

## Contents :-

#### [[#01 - Introduction]]
#### [[#02 - Subnetworks]]
#### [[#03 - Enumerating Targets]]
#### [[#04 - Discovering Live Hosts]]
#### [[#05 - Reverse-DNS Lookup]]
#### [[#06 - NSE]]
#### [[#Additional Information]]

---

## 01 - Introduction

- When we want to target a network, we want to find an efficient tool to help us handle repetitive tasks and answer the following questions:
	1. Which systems are up?
	2. What services are running on these systems?
- **Nmap** (***Network Mapper***) is a free, open-source software released under GPL license. Nmap is an industry-standard tool for mapping networks, identifying live hosts, and discovering running services.
- Different approaches that Nmap uses to discover live hosts:
	1. **ARP scan** - uses ARP requests to discover live hosts
	2. **ICMP scan** - uses ICMP requests to identify live hosts
	3. **TCP/UDP ping scan** - sends packets to TCP ports and UDP ports to determine live hosts

![[nmap-steps.png]]

---

## 02 - Subnetworks

- **Network Segment** - a group of computers connected using a shared medium
- In an IP network, a **subnetwork** is usually the equivalent of one or more network segments connected together and configured to use the same router. 
- The network segment refers to a *physical* connection, while a subnetwork refers to a *logical* connection.
- A subnetwork, or simply a **subnet**, has its own IP address range and is connected to a more extensive network via a router.
- Subnets with `/16` means that the subnet mask can be written as `255.255.0.0`. This subnet can have around 65,000 hosts.
- Subnets with `/24` means that the subnet mask can be expressed as `255.255.255.0`. This subnet can have around 250 hosts.
- If you are connected to the same subnet, you would expect your scanner to rely on **ARP** (***Address Resolution Protocol***) queries to discover live hosts. An ARP query aims to get the hardware address (MAC address) so that communication over the link-layer becomes possible; however, we can use this to infer that the host is online.
- If you are connected to a subnet different from the subnet of the target system(s), all packets generated by your scanner will be routed via the default gateway (router) to reach the systems on another subnet; however, the ARP queries won’t be routed and hence cannot cross the subnet router. ARP is a link-layer protocol, and ARP packets are bound to their subnet.

---

## 03 - Enumerating Targets

- Targets can be specified by providing:
	- a list
	- a range
	- a subnet
	- a file with list of targets
- `nmap -sL TARGETS`: to check the list of hosts that Nmap will scan. This option will give you a detailed list of the hosts that Nmap will scan without scanning them; however, Nmap will attempt a reverse-DNS resolution on all the targets to obtain their names.``


---

## 04 - Discovering Live Hosts


![[nmap-protocols.png]]

- **ARP** (***Address Resolution Protocol***) **from Link Layer**- sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.
- **ICMP** (***Internet Control Message Protocol***) **from Network Layer** -  ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply). To ping a system on the same subnet, an ARP query should precede the ICMP Echo. 
- **TCP** (***Transport Control Protocol***) **and UDP** (***User Datagram Protocol***) **from Transport Layer** - for network scanning purposes, a scanner can send a specially-crafted packet to common TCP or UDP ports to check whether the target will respond. This method is efficient, especially when ICMP Echo is blocked.

### 04.01 - Nmap Host Discovery Using ARP

When no host discovery options are provided, Nmap follows the following approaches to discover live hosts:

1. When a _privileged_ user tries to scan targets on a local network (Ethernet), Nmap uses _ARP requests_. A privileged user is `root` or a user who belongs to `sudoers` and can run `sudo`.
2. When a _privileged_ user tries to scan targets outside the local network, Nmap uses ICMP echo requests, TCP ACK (Acknowledge) to port 80, TCP SYN (Synchronize) to port 443, and ICMP timestamp request.
3. When an _unprivileged_ user tries to scan targets outside the local network, Nmap resorts to a TCP 3-way handshake by sending SYN packets to ports 80 and 443.

![[nmap-ARP.png]]

- Nmap, by default, uses a ping scan to find live hosts, then proceeds to scan live hosts only. 
- The MAC address is necessary for the link-layer header; the header contains the source MAC address and the destination MAC address among other fields. To get the MAC address, the OS sends an ARP query. A host that replies to ARP queries is up. The ARP query only works if the target is on the same subnet as yourself, i.e., on the same Ethernet/WiFi.
- `nmap -sn TARGETS`: discover online hosts without port-scanning the live systems
- `nmap -PR -sn TARGETS`: perform an ARP scan without port-scanning, where `-PR` indicates that you only want an ARP scan
- `arp-scan` - a scanner built around ARP queries. Can be installed using: `apt install arp-scan`
- `arp-scan --localnet` or `arp-scan -l`: send ARP queries to all valid IP addresses on your local networks

### 04.02 - Nmap Host Discovery Using ICMP

- Many firewalls block ICMP echo requests.
- An ARP query will precede the ICMP request if your target is on the same subnet.
- To use ICMP echo request to discover live hosts, add the option `-PE`. (Remember to add `-sn` if you don’t want to follow that with a port scan)
- An ICMP echo scan works by sending an ICMP echo request and expects the target to reply with an ICMP echo reply if it is online.

![[nmap-ICMP.png]]

- If the scan output shows MAC addresses of the hosts, it indicates that Nmap didn’t need to send ICMP packets as it confirmed that these hosts are up based on the ARP responses it received.
- Because ICMP echo requests tend to be blocked, you might also consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online. 
- Nmap uses timestamp request (*ICMP Type 13*) and checks whether it will get a Timestamp reply (*ICMP Type 14*).  Adding the `-PP` option tells Nmap to use ICMP timestamp requests.
- Nmap uses address mask queries (*ICMP Type 17*) and checks whether it gets an address mask reply (*ICMP Type 18*). This scan can be enabled with the option `-PM`.
- It is essential to learn multiple approaches to achieve the same result. If one type of packet is being blocked, we can always choose another to discover the target network and services.

### 04.03 - Nmap Host Discovery Using TCP and UDP

#### TCP Connect Ping

- A TCP Connect scan works by performing the three-way handshake with each target port in turn.
- If Nmap sends a TCP request with the _SYN_ flag set to a **_closed_** port, the target server will respond with a TCP packet with the _RST_ (Reset) flag set. 
- If, however, the request is sent to an _open_ port, the target will respond with a TCP packet with the SYN/ACK flags set.
- Many firewalls are configured to simply **drop** incoming packets. Nmap sends a TCP SYN request, and receives nothing back. This indicates that the port is being protected by a firewall and thus the port is considered to be _filtered_. It is very easy to configure a firewall to respond with a RST TCP packet. For example, in IPtables for Linux, a simple version of the command would be as follows:
	`iptables -I INPUT -p tcp --dport <port> -j REJECT --reject-with tcp-reset`

#### TCP SYN Ping (Half-open/Stealth scans)

- Send a packet with the **SYN** (***Synchronize***) flag set to a TCP port, 80 by default, and wait for a response. An open port should reply with a **SYN/ACK** (***Acknowledge***); a closed port would result in an **RST** (***Reset***).
- To use TCP SYN ping, add the option `-PS` followed by the port number, range, list, or a combination of them.

![[nmap-TCP-unprivileged.png]]

- Privileged users (root and sudoers) can send TCP SYN packets and don’t need to complete the TCP 3-way handshake even if the port is open. Unprivileged users have no choice but to complete the 3-way handshake if the port is open.
- Where TCP scans perform a full three-way handshake with the target, SYN scans sends back a RST TCP packet after receiving a SYN/ACK from the server.

![[nmap-TCP-privileged.png]]

#### TCP ACK Ping

- Sends a packet with an ACK flag set using port 80 by default. You must be running Nmap as a privileged user to be able to accomplish this. If you try it as an unprivileged user, Nmap will attempt a 3-way handshake.
- To use TCP ACK ping, option `-PA` should be followed by a port number, range, list, or a combination of them.
- Any TCP packet with an ACK flag should get a TCP packet back with an RST flag set. The target responds with the RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection.

![[nmap-TCP-ACK.png]]

#### UDP Ping

- Sending a UDP packet to an open port is not expected to lead to any reply. However, if we send a UDP packet to a closed UDP port, we expect to get an ICMP port unreachable packet.

![[nmap-UDP.png]]

- Nmap uses `-PU` for UDP ping.
- UDP scans tend to be incredibly slow in comparison to the various TCP scans. For this reason it's usually good practice to run an Nmap scan with `--top-ports <number>` enabled.

### 04.04 - Firewall Evasion

- NULL, FIN and Xmas TCP port scans are used for firewall evasion,
- **NULL scans** (`-sN`) are when the TCP request is sent with no flags set at all. As per the RFC, the target host should respond with a RST if the port is closed.
- **FIN scans** (`-sF`) work in an almost identical fashion; however, instead of sending a completely empty packet, a request is sent with the FIN flag (usually used to gracefully close an active connection).
- **Xmas scans** (`-sX`) send a malformed TCP packet and expects a RST response for closed ports. It's referred to as an xmas scan as the flags that it sets (*PSH, URG and FIN*) give it the appearance of a blinking christmas tree when viewed as a packet capture in Wireshark.

### NOTE:

#### Masscan

- Masscan uses a similar approach to discover the available systems. However, to finish its network scan quickly, Masscan is quite aggressive with the rate of packets it generates. 
- The syntax is quite similar: `-p` can be followed by a port number, list, or range. 
- Masscan can be installed using: `apt install masscan`

---

## 05 - Reverse-DNS Lookup

- Nmap’s default behavior is to use reverse-DNS online hosts. To skip this, use `-n`.
- By default, Nmap will look up online hosts; however, option `-R` can be used to query the DNS server even for offline hosts. 
- To use a specific DNS server, add the `--dns-servers DNS_SERVER` option.

---

## 06 - NSE

- **NSE** (***Nmap Scripting Engine***)
- NSE Scripts are written in the _Lua_ programming language, and can be used to do a variety of things: from scanning for vulnerabilities, to automating exploits for them.
- Some useful categories include:
	- `safe`: Won't affect the target
	- `intrusive`: Not safe: likely to affect the target  
	- `vuln`: Scan for vulnerabilities
	- `exploit`: Attempt to exploit a vulnerability
	- `auth`: Attempt to bypass authentication for running services (e.g. Log into an FTP server anonymously)
	- `brute`: Attempt to bruteforce credentials for running services
	- `discovery`: Attempt to query running services for further information about the network (e.g. query an SNMP server).
- Nmap stores its scripts on Linux at `/usr/share/nmap/scripts`.
- Search for installed scripts by using the `/usr/share/nmap/scripts/script.db` file.

---

#additional-info 

## Additional Information

### Summary

| Scan Type              | Example Command                              |
| ---------------------- | -------------------------------------------- |
| ARP Scan               | `sudo nmap -PR -sn MACHINE_IP/24`            |
| ICMP Echo Scan         | `sudo nmap -PE -sn MACHINE_IP/24`            |
| ICMP Timestamp Scan    | `sudo nmap -PP -sn MACHINE_IP/24`            |
| ICMP Address Mask Scan | `sudo nmap -PM -sn MACHINE_IP/24`            |
| TCP SYN Ping Scan      | `sudo nmap -PS 22,80,443 -sn MACHINE_IP/30`  |
| TCP ACK Ping Scan      | `sudo nmap -PA 22,80,443 -sn MACHINE_IP/30`  |
| UDP Ping Scan          | `sudo nmap -PU 53,161,162 -sn MACHINE_IP/30` |
|                        |                                              |

Remember to add `-sn` if you are only interested in host discovery without port-scanning.  Omitting `-sn` will let Nmap default to port-scanning the live hosts.

|Option|Purpose|
|---|---|
|`-n`|no DNS lookup|
|`-R`|reverse-DNS lookup for all hosts|
|`-sn`|host discovery only|

### Links

- [ICMP Types](https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml)
- [NTA Open Source Tools](https://www.royhills.co.uk/wiki/index.php/Main_Page)
- [Nmap - NSE](https://nmap.org/book/nse-usage.html)

---